<!DOCTYPE html>
<html>
  <head>
    <title>Encuesta</title>
    <link rel="stylesheet" href="/static/css/reset.css" />
    <link rel="stylesheet" href="/static/css/encuesta.css" />
  </head>
  <body>
    <h2 id="titulo">Encuesta</h2>

    <form id="encuesta-form">
      <input type="hidden" name="token" value="{{ token }}" />
      <div id="preguntas-container"></div>
      <button type="submit">Enviar</button>
    </form>

    <p id="mensaje"></p>

    <script
      defer
      src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"
    ></script>
    <script defer>
      const tipoEncuesta = "{{ tipo_encuesta }}";
      const preguntasContainer = document.getElementById("preguntas-container");
      const titulo = document.getElementById("titulo");

      const plantillas = {
        satisfaccion: {
          titulo: "Encuesta de Satisfacción",
          html: `
            <label>¿Cómo calificarías tu atención?</label>
            <select name="satisfaccion" required>
              <option value="">--Selecciona--</option>
              <option value="excelente">Excelente</option>
              <option value="buena">Buena</option>
              <option value="regular">Regular</option>
              <option value="mala">Mala</option>
            </select>
            <label>¿Comentarios adicionales?</label>
            <textarea name="comentarios" rows="3"></textarea>
          `,
        },
        pre_sesion: {
          titulo: "Encuesta Pre-Sesión",
          html: `
            <label>¿Descansaste bien anoche?</label>
            <select name="descanso" required>
              <option value="">--Selecciona--</option>
              <option value="si">Sí</option>
              <option value="no">No</option>
            </select>
            <label>¿Has tenido fiebre o malestar general?</label>
            <select name="malestar" required>
              <option value="">--Selecciona--</option>
              <option value="si">Sí</option>
              <option value="no">No</option>
            </select>
          `,
        },
        seguimiento: {
          titulo: "Encuesta de Seguimiento",
          html: `
            <label>¿Cómo te has sentido esta semana?</label>
            <select name="estado_animo" required>
              <option value="">--Selecciona--</option>
              <option value="bien">Bien</option>
              <option value="regular">Regular</option>
              <option value="mal">Mal</option>
            </select>
            <label>¿Has tenido efectos adversos?</label>
            <textarea name="efectos" rows="3"></textarea>
          `,
        },
      };

      const plantilla = plantillas[tipoEncuesta] || plantillas.satisfaccion;
      titulo.textContent = plantilla.titulo;
      preguntasContainer.innerHTML = plantilla.html;

      const form = document.getElementById("encuesta-form");
      const mensaje = document.getElementById("mensaje");
      const COLOR_SUCCESS = "#2ecc71";
      const COLOR_ERROR = "#e74c3c";

      function launchConfetti() {
        if (window.confetti) {
          confetti({
            particleCount: 150,
            spread: 90,
            startVelocity: 40,
            origin: { y: 0.6 },
          });
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        mensaje.textContent = "";

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
          const res = await fetch("/encuesta", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          if (res.ok) {
            mensaje.textContent = "¡Gracias por tu respuesta!";
            mensaje.style.color = COLOR_SUCCESS;
            launchConfetti();
            form.reset();
          } else {
            const err = await res.json();
            mensaje.textContent =
              "Error: " + (err.detail || err.error || "Algo salió mal");
            mensaje.style.color = COLOR_ERROR;
          }
        } catch (err) {
          mensaje.textContent = "Error de conexión";
          mensaje.style.color = COLOR_ERROR;
        }
      });
    </script>
  </body>
</html>
